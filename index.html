<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Worker App</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Worker">

  <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180.png"> 
  <link rel="icon" href="favicon.png" type="image/png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    /* RESET BASIQUE */
    body {
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      background-color: #000000;
      color: #ffffff;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }

    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    input, select, textarea, button { font-size: 16px !important; outline: none; }

    /* Bento Card */
    .bento-card {
        background-color: #1C1C1E;
        border-radius: 18px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #2C2C2E;
    }

    /* Inputs */
    .big-input {
        background: #2C2C2E;
        border-radius: 12px;
        height: 50px;
        width: 100%;
        padding: 0 16px;
        color: white;
        border: 1px solid transparent;
        transition: all 0.2s;
        appearance: none; -webkit-appearance: none;
    }
    .big-input:focus {
        background: #3A3A3C;
        border-color: #0A84FF;
    }
    
    #month-select { text-align-last: center; }

    /* Nav Blur */
    .nav-blur {
        background: rgba(28, 28, 30, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    header.nav-blur { padding-top: calc(env(safe-area-inset-top) + 10px); }
    #pane { padding-top: calc(env(safe-area-inset-top) + 80px) !important; }

    /* Nav Btn */
    .nav-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 100%; height: 100%; background: transparent; border: none;
        color: #8E8E93; gap: 4px;
    }
    .nav-btn.is-active { color: #0A84FF; }
    .nav-icon { font-size: 22px; margin-bottom: -2px; }
    .nav-label { font-size: 10px; font-weight: 500; }

    /* Hero Button */
    .date-hero-btn {
        background: linear-gradient(135deg, #0A84FF 0%, #007AFF 100%);
        color: white;
        width: 100%; padding: 20px; border-radius: 20px;
        display: flex; justify-content: space-between; align-items: center;
        border: none; box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
    }

    .tab-content { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Modal */
    #calendar-modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        z-index: 2000; display: none; align-items: flex-end; justify-content: center;
    }
    #calendar-container {
        background: #1C1C1E; width: 100%; border-radius: 24px 24px 0 0;
        padding: 24px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
        box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    }
    .cal-btn {
        width: 100%; aspect-ratio: 1; border-radius: 12px; border: none;
        background: transparent; color: white; font-weight: 500;
    }
    .cal-btn.is-selected { background: #0A84FF; font-weight: 700; }
    .cal-btn.is-today { border: 2px solid #0A84FF; }
    
    .privacy-blur { filter: blur(6px); user-select: none; transition: filter 0.3s ease; }
    .privacy-visible { filter: blur(0); }
    ::-webkit-scrollbar { display: none; }
  </style>
</head>

<body>

  <div id="splash-screen" style="position:fixed; inset:0; background:#000; z-index:9999; display:flex; justify-content:center; align-items:center; transition:opacity 0.4s;">
    <div style="font-size:32px; font-weight:800; background: -webkit-linear-gradient(#0A84FF, #5AC8FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
      Worker.
    </div>
  </div>

  <header class="fixed top-0 left-0 right-0 z-40 nav-blur px-4 pb-3">
    <div class="flex justify-between items-end">
      <div>
        <h1 class="text-2xl font-bold tracking-tight text-white">Worker</h1>
        <p class="text-xs text-gray-400 font-medium uppercase tracking-wide">Suivi d'heures</p>
      </div>
      <div id="profile-picture-container" class="h-8 w-8 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 bg-cover bg-center">
        <span id="profile-initials" class="text-lg">üë§</span>
      </div>
    </div>
  </header>

  <main id="pane" class="w-full min-h-screen pb-28 px-4">
    
    <section id="tab-saisie" class="tab-content">
      <div class="mb-4">
        <button id="entry-date-button" class="date-hero-btn active:scale-95 transition-transform duration-100">
          <div class="text-left">
            <div class="text-blue-100 text-sm font-medium opacity-80">Date</div>
            <div id="entry-date-display" class="text-2xl font-bold">Aujourd'hui</div>
          </div>
          <div class="bg-white/20 p-2 rounded-lg text-xl">üìÖ</div>
        </button>
        <input type="hidden" id="entry-date-hidden" />
      </div>

      <div class="bento-card">
        <label class="text-xs text-gray-400 uppercase font-bold mb-2 block">Type</label>
        <div class="relative">
          <select id="entry-type-select" class="big-input appearance-none">
            <option value="WORK">üíº &nbsp; Travail (Bureau)</option>
            <option value="REMOTE">üè† &nbsp; T√©l√©travail</option>
            <option value="RTT">üèñ &nbsp; RTT</option>
            <option value="VACATION">‚úàÔ∏è &nbsp; Vacances</option>
            <option value="HOLIDAY">üéâ &nbsp; F√©ri√©</option>
          </select>
          <div class="absolute right-4 top-4 pointer-events-none text-gray-400">‚ñº</div>
        </div>
      </div>

      <div id="work-card" class="bento-card transition-opacity duration-300">
        <div class="flex justify-between items-center mb-3">
          <label class="text-xs text-gray-400 uppercase font-bold">Horaires</label>
          <span id="current-day-minutes" class="text-xs font-bold px-2 py-1 rounded bg-green-500/20 text-green-400">0h 00m</span>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <span class="text-[10px] text-gray-500 uppercase block mb-1 ml-1">D√©but</span>
            <input type="time" id="start-time" class="big-input text-center font-bold text-lg"/>
          </div>
          <div>
            <span class="text-[10px] text-gray-500 uppercase block mb-1 ml-1">Fin</span>
            <input type="time" id="end-time" class="big-input text-center font-bold text-lg"/>
          </div>
        </div>

        <div class="mt-4 pt-3 border-t border-gray-700">
           <div class="flex justify-between items-center mb-2">
             <span class="text-sm text-gray-300">Pause midi</span>
             <span id="lunch-duration-display" class="text-sm font-mono text-blue-400">45min (minimum l√©gal)</span>
           </div>
           <input type="number" id="lunch-duration-manual" class="big-input text-right" placeholder="Modifier (min)" inputmode="numeric">
        </div>
      </div>

      <div class="grid grid-cols-4 gap-3 mt-2">
        <button id="auto-fill-btn" class="col-span-1 h-[50px] rounded-xl bg-purple-800/50 text-purple-300 text-xl border border-purple-700 flex items-center justify-center" title="Remplir auto">‚ö°Ô∏è</button>
        <button id="clear-entry-btn" class="col-span-1 h-[50px] rounded-xl bg-gray-800 text-gray-400 text-xl border border-gray-700 flex items-center justify-center">‚Ü∫</button>
        <button id="save-entry-btn" class="col-span-2 h-[50px] rounded-xl bg-blue-600 text-white font-bold text-lg shadow-lg shadow-blue-900/50 active:scale-95 transition-transform">Enregistrer</button>
      </div>
      <button id="delete-entry-btn" class="w-full mt-3 py-3 text-red-500 text-sm font-medium" style="display:none;">Supprimer</button>

      <div class="mt-8">
        <h3 class="text-sm font-bold text-gray-500 uppercase mb-3 px-2">R√©cent</h3>
        <div id="latest-list" class="space-y-2"></div>
      </div>
    </section>
    
    <section id="tab-hebdo" class="tab-content" style="display:none;">
      <div class="bento-card bg-gradient-to-br from-slate-800 to-slate-900">
        <div class="flex justify-between items-end mb-4">
          <div>
             <div class="text-gray-400 text-xs uppercase">Total Semaine</div>
             <div id="total-weekly-hours" class="text-3xl font-bold text-white mt-1">0h 00m</div>
          </div>
          <div class="text-right">
             <div class="text-gray-400 text-xs uppercase">Objectif</div>
             <div id="target-weekly-hours-summary" class="text-blue-400 font-bold">37h 00m</div>
          </div>
        </div>
        
        <div class="w-full bg-gray-700 h-3 rounded-full overflow-hidden mb-2">
           <div id="weekly-progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="progress-bar-label" class="text-center text-xs text-gray-400 font-mono">0%</div>
      </div>

      <div id="weekly-body" class="bento-card divide-y divide-gray-700/50 p-0 overflow-hidden">
      </div>
    </section>

    <section id="tab-mensuelle" class="tab-content" style="display:none;">
      <div class="flex items-center gap-2 mb-4 bento-card p-2">
        <button id="month-prev" class="w-10 h-10 flex items-center justify-center bg-gray-800 rounded-lg text-white">‚Äπ</button>
        <select id="month-select" class="flex-grow bg-transparent text-center text-white font-bold h-10 outline-none"></select>
        <button id="month-next" class="w-10 h-10 flex items-center justify-center bg-gray-800 rounded-lg text-white">‚Ä∫</button>
      </div>

      <div class="bento-card bg-gradient-to-br from-purple-800/80 to-pink-800/80 mb-4">
          <div class="flex justify-between items-center mb-3">
              <h3 class="text-xs text-white uppercase font-bold">Estimation Salariale</h3>
              <button id="monthly-privacy-toggle" class="text-xl text-white opacity-70">üîí</button>
          </div>
          
          <div id="finance-details-container">
              <div class="flex justify-between items-center py-2 border-b border-white/20">
                  <span class="text-sm font-medium">Salaire de base BRUT (151.67h)</span>
                  <span id="monthly-base-salary-gross" class="font-bold text-lg text-white privacy-blur">0.00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-white/20">
                  <span class="text-sm font-medium">Salaire de base NET (Brut -23%)</span>
                  <span id="monthly-base-salary-net" class="font-bold text-lg text-blue-300 privacy-blur">0.00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-white/20">
                  <span class="text-sm font-medium">Indemnit√©s Repas NET</span>
                  <span id="monthly-meal-allowance" class="font-bold text-sm text-pink-300 privacy-blur">0.00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-white/20">
                  <span class="text-sm font-medium">Indemnit√©s KM NET</span>
                  <span id="monthly-km-allowance" class="font-bold text-sm text-green-300 privacy-blur">0.00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between items-center pt-3">
                  <span class="text-lg font-bold">Total NET</span>
                  <span id="monthly-grand-total" class="font-extrabold text-2xl text-yellow-300 privacy-blur">0.00 ‚Ç¨</span>
              </div>
          </div>
      </div>

      <div class="bento-card mb-4">
        <h3 class="text-xs text-gray-400 uppercase font-bold mb-3">Performance Hebdomadaire</h3>
        <div style="height: 200px; width: 100%;">
            <canvas id="monthly-chart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="bento-card flex flex-col items-center justify-center py-6">
           <span id="monthly-days-worked" class="text-3xl font-bold text-green-400">0</span>
           <span class="text-xs text-gray-500 uppercase mt-1">Jours Travaill√©s</span>
        </div>
        <div class="bento-card flex flex-col items-center justify-center py-6">
           <span id="monthly-total-work-hours" class="text-2xl font-bold text-white">0h</span>
           <span class="text-xs text-gray-500 uppercase mt-1">Heures Totales</span>
        </div>
      </div>

      <div class="bento-card">
        <h3 class="text-xs text-gray-400 uppercase font-bold mb-3">Compteurs</h3>
        <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
           <span>Jours T√©l√©travail</span>
           <span id="monthly-remote-days" class="font-bold text-purple-400 text-lg">0</span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
          <span>Solde RTT</span>
          <span id="current-rtt-balance" class="font-bold text-blue-400 text-lg">0</span>
        </div>
        <div class="flex justify-between items-center py-2">
          <span>Solde CP</span>
          <span id="current-vacation-balance" class="font-bold text-pink-400 text-lg">0</span>
        </div>
      </div>
    </section>

    <section id="tab-data" class="tab-content" style="display:none;">
      <h3 class="text-sm font-bold text-gray-500 uppercase mb-3 px-2">Historique complet</h3>
      <div id="data-list-container" class="space-y-2"></div>
    </section>

    <section id="tab-reglages" class="tab-content" style="display:none;">
        
      <div class="bento-card mb-4" id="cloud-section">
          <h3 class="text-xs text-gray-400 uppercase font-bold mb-3">Sauvegarde Cloud ‚òÅÔ∏è</h3>
          
          <div id="logged-out-view">
            <p class="text-sm text-gray-400 mb-3">Connectez-vous pour synchroniser vos donn√©es et ne jamais les perdre.</p>
            <button id="btn-login-google" class="w-full h-[44px] rounded-xl bg-[#4285F4] text-white font-bold text-sm flex items-center justify-center gap-2 active:scale-[0.98] transition-transform">
              <span class="bg-white text-transparent bg-clip-text text-lg" style="-webkit-text-fill-color: white;">G</span> Continuer avec Google
            </button>
          </div>

          <div id="logged-in-view" class="hidden">
            <div class="flex items-center gap-3 mb-3">
              <div id="user-avatar" class="w-10 h-10 rounded-full bg-gray-700 bg-cover bg-center"></div>
              <div class="overflow-hidden">
                <div id="user-name" class="text-sm font-bold text-white truncate">Utilisateur</div>
                <div id="user-email" class="text-xs text-gray-500 truncate">email@test.com</div>
              </div>
            </div>
            <div class="flex gap-2">
                <button id="btn-force-sync" class="flex-1 h-[36px] rounded-lg bg-blue-600/30 text-blue-400 text-xs font-bold border border-blue-600/50">Forcer Sync ‚Üª</button>
                <button id="btn-logout" class="h-[36px] px-4 rounded-lg bg-red-600/20 text-red-400 text-xs font-bold border border-red-600/30">D√©connexion</button>
            </div>
            <p id="last-sync-msg" class="text-[10px] text-gray-500 mt-2 text-center">Derni√®re sync: Jamais</p>
          </div>
      </div>

      <div class="bento-card space-y-4">
        <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Photo de Profil</label>
        <div class="flex items-center space-x-4">
          <div id="settings-profile-preview" class="h-12 w-12 rounded-full bg-gray-800 border border-gray-700 bg-cover bg-center flex items-center justify-center text-2xl">üë§</div>
          <div class="flex-grow">
            <input type="file" id="profile-picture-file" accept="image/*" class="hidden"> 
            <button id="select-profile-picture-btn" class="w-full h-10 rounded-lg bg-gray-700 text-sm text-white font-medium active:scale-[0.98] transition-transform">Choisir une image</button>
            <button id="clear-profile-picture-btn" class="w-full h-10 rounded-lg bg-red-700/50 text-sm text-red-300 font-medium mt-2 active:scale-[0.98] transition-transform" style="display:none;">Supprimer</button>
          </div>
        </div>
      </div>
      
      <div class="bento-card space-y-4">
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Taux Horaire Brut (‚Ç¨)</label>
          <input type="number" step="0.01" id="hourly-gross-rate" class="big-input" value="0.00">
        </div>
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Indemnit√© Repas (NET ‚Ç¨)</label>
          <input type="number" step="0.01" id="daily-meal-allowance" class="big-input" value="0.00">
        </div>
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Indemnit√© KM (NET ‚Ç¨)</label>
          <input type="number" step="0.01" id="daily-km-allowance" class="big-input" value="0.00">
        </div>
        <div class="flex justify-between items-center pt-3 border-t border-gray-700">
           <label class="text-sm text-gray-300">Activer le flou sur les chiffres</label>
           <button id="toggle-privacy-btn" class="text-2xl text-blue-400">üîí</button>
        </div>
      </div>
      
      <div class="bento-card space-y-4">
         <button id="open-default-times-btn" class="w-full h-10 rounded-lg bg-blue-700 text-sm text-white font-bold active:scale-[0.98] transition-transform">Pr√©-remplissage des Horaires</button>
      </div>

      <div class="bento-card space-y-4">
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Objectif Hebdomadaire (h)</label>
          <input type="number" id="target-hours" class="big-input" value="37.0">
        </div>
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Pause Midi Standard (min)</label>
          <input type="number" id="lunch-minutes" class="big-input" value="45">
        </div>
      </div>

      <div class="bento-card space-y-4">
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Stock RTT Initial</label>
          <input type="number" id="initial-rtt-days" class="big-input" value="10">
        </div>
        <div>
          <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Stock CP Initial</label>
          <input type="number" id="initial-vacation-days" class="big-input" value="25">
        </div>
      </div>

      <button id="save-settings-btn" class="w-full h-[50px] rounded-xl bg-blue-600 text-white font-bold text-lg mb-6 active:scale-[0.98] transition-transform">Sauvegarder</button>

      <div class="grid grid-cols-2 gap-3">
        <button id="export-data-btn" class="h-10 rounded-lg bg-gray-800 text-sm text-gray-300 active:scale-[0.98] transition-transform">Exporter CSV</button>
        <button id="import-data-btn" class="h-10 rounded-lg bg-gray-800 text-sm text-gray-300 active:scale-[0.98] transition-transform">Importer CSV</button>
        <input id="import-file" type="file" accept=".csv" class="hidden">
      </div>
      
      <div class="text-center text-xs text-gray-600 mt-6 pb-4">ID: <span id="user-id-display">Local</span></div>
    </section>
  </main>

  <nav id="tabbar" class="fixed bottom-0 left-0 right-0 z-50 nav-blur safe-bottom">
    <div class="flex justify-around items-center h-[60px] max-w-md mx-auto">
      <button id="btn-saisie" class="nav-btn is-active">
        <span class="nav-icon">‚úèÔ∏è</span> <span class="nav-label">Saisie</span>
      </button>
      <button id="btn-hebdo" class="nav-btn">
        <span class="nav-icon">üìä</span> <span class="nav-label">Hebdo</span>
      </button>
      <button id="btn-mensuelle" class="nav-btn">
        <span class="nav-icon">üóì</span> <span class="nav-label">Mois</span>
      </button>
      <button id="btn-data" class="nav-btn">
        <span class="nav-icon">üìÇ</span> <span class="nav-label">Data</span>
      </button>
      <button id="btn-reglages" class="nav-btn">
        <span class="nav-icon">‚öôÔ∏è</span> <span class="nav-label">R√©glages</span>
      </button>
    </div>
  </nav>

  <div id="custom-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:3000; display:none; align-items:center; justify-content:center; padding:20px;">
    <div class="bg-[#1C1C1E] border border-gray-700 rounded-2xl p-6 w-full max-w-xs shadow-2xl transform scale-100">
      <h3 id="modal-title" class="text-white text-lg font-bold mb-2">Titre</h3>
      <p id="modal-message" class="text-gray-400 text-sm mb-6 leading-relaxed">Message</p>
      <button id="close-modal-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">OK</button>
    </div>
  </div>

  <div id="calendar-modal">
    <div id="calendar-container">
       <div class="flex justify-between items-center mb-6 px-2">
         <button id="calendar-prev" class="text-blue-500 text-lg p-2 font-bold">Pr√©c.</button>
         <span id="calendar-title" class="text-white font-bold text-lg capitalize">Mois</span>
         <button id="calendar-next" class="text-blue-500 text-lg p-2 font-bold">Suiv.</button>
       </div>
       <div class="grid grid-cols-7 gap-1 text-center mb-2">
         <div class="text-xs text-gray-500 font-bold">L</div>
         <div class="text-xs text-gray-500 font-bold">M</div>
         <div class="text-xs text-gray-500 font-bold">M</div>
         <div class="text-xs text-gray-500 font-bold">J</div>
         <div class="text-xs text-gray-500 font-bold">V</div>
         <div class="text-xs text-gray-500 font-bold">S</div>
         <div class="text-xs text-gray-500 font-bold">D</div>
       </div>
       <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
       <button id="close-calendar-btn" class="w-full bg-gray-800 text-white font-bold py-4 rounded-xl mt-6">Fermer</button>
    </div>
  </div>

  <div id="default-times-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:2500; display:none; align-items:center; justify-content:center; padding:20px;">
    <div class="bg-[#1C1C1E] border border-gray-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl h-[80vh] overflow-y-auto">
        <h3 class="text-white text-xl font-bold mb-4">Horaires par d√©faut</h3>
        <p class="text-gray-400 text-xs mb-4">D√©finissez vos horaires types pour le remplissage automatique.</p>
        <div id="day-list-container" class="space-y-3 mb-4"></div>
        <button id="close-default-times-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Fermer</button>
    </div>
  </div>

  <div id="time-picker-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2600; display:none; align-items:center; justify-content:center; padding:20px;">
      <div class="bg-[#2C2C2E] border border-gray-600 rounded-2xl p-6 w-full max-w-xs shadow-2xl">
        <h3 id="time-picker-title" class="text-white text-lg font-bold mb-4 text-center">Lundi</h3>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">D√©but</label>
                <input type="time" id="default-start-time" class="big-input text-center font-bold text-lg" value="09:00"/>
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold mb-1 block">Fin</label>
                <input type="time" id="default-end-time" class="big-input text-center font-bold text-lg" value="17:30"/>
            </div>
        </div>
        <button id="save-default-times-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-6">Sauvegarder</button>
        <button id="clear-default-times-btn" class="w-full bg-red-600/50 text-red-300 font-bold py-3 rounded-xl mt-2">Effacer les horaires</button>
        <button id="cancel-time-picker-btn" class="w-full bg-transparent text-gray-400 font-bold py-3 rounded-xl mt-2">Annuler</button>
      </div>
  </div>

<script type="module">
  // --- IMPORTS FIREBASE & CONFIG ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCT9BmVNesMSNdodA3d2gI_JWS9XptD5bY",
    authDomain: "worker-7526f.firebaseapp.com",
    projectId: "worker-7526f",
    storageBucket: "worker-7526f.firebasestorage.app",
    messagingSenderId: "1063639159692",
    appId: "1:1063639159692:web:7f8fa02e3c4e112e3a3ca9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentUser = null;

  // --- CONSTANTES ---
  const CDI_MONTHLY_HOURS = 151.67;
  const BRUT_TO_NET_DEDUCTION = 0.23;
  const DAY_NAMES = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
  const DAY_KEYS = ['LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM', 'DIM'];

  // --- VARIABLES ---
  let workEntries = [];
  let config = {
      targetWeeklyHours: 37 * 60,
      lunchDurationMinutes: 45,
      hourlyGrossRate: 0,
      dailyMealAllowance: 0,
      dailyKmAllowance: 0,
      initialRttDays: 10,
      initialVacationDays: 25,
      lastSelectedDate: new Date().toISOString().substring(0, 10),
      selectedMonthYM: new Date().toISOString().substring(0, 7),
      userProfilePic: null,
      privacyMode: false,
      defaultTimes: {}
  };
  let monthlyChartInstance = null;
  let currentCalDate = new Date();

  const $ = q => document.querySelector(q);

  // --- HELPERS DATE & CALCUL ---
  const dateToYMD = d => {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };
  const formatFrDate = ymd => {
    if(!ymd) return '';
    const [y,m,d]=ymd.split('-');
    return `${d}/${m}/${y}`;
  };
  const dateToHuman = ymd => {
    const d = new Date(ymd + 'T00:00:00');
    return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
  };
  const getDayOfWeekIndex = (ymd) => {
    const d = new Date(ymd + 'T00:00:00');
    return (d.getDay() + 6) % 7; 
  }
  const fmtMinutes = m => {
    const s=m<0?"-":"";
    const a=Math.abs(m);
    const h=Math.floor(a/60);
    const mn=Math.round(a%60);
    return `${s}${h}h ${mn<10?'0':''}${mn}m`;
  };
  const calcWorkMinutes = (e)=>{
    if(e?.type!=='WORK' && e?.type!=='REMOTE') return config.targetWeeklyHours / 5; 
    if(!e.start||!e.end) return 0;
    const p=t=>{const [h,m]=t.split(':').map(Number);return h*60+m};
    const lunch=(e.lunchDurationMinutes ?? config.lunchDurationMinutes) || 0;
    return Math.max(p(e.end)-p(e.start)-lunch,0);
  };
  const addMonths = (ym, d)=>{
    let [y,m]=ym.split('-').map(Number);
    m+=d;
    while(m>12){m-=12;y++;}
    while(m<1){m+=12;y--;}
    return `${y}-${String(m).padStart(2,'0')}`;
  };
  const monthLabel = (ym) => {
    const [y,m]=ym.split('-').map(Number);
    return new Date(y,m-1,1).toLocaleString('fr-FR', { month:'long', year:'numeric' });
  };

  // --- SYNC GOOGLE ---
  const googleProvider = new GoogleAuthProvider();

  function setupAuthListeners() {
      $('#btn-login-google').addEventListener('click', () => signInWithCloud(googleProvider));
      $('#btn-logout').addEventListener('click', () => signOut(auth));
      $('#btn-force-sync').addEventListener('click', () => syncData(true));
  }

  async function signInWithCloud(provider) {
      try { await signInWithPopup(auth, provider); } 
      catch (error) { showModal("Erreur connexion", error.message); }
  }

  onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      const loginView = $('#logged-in-view');
      const logoutView = $('#logged-out-view');

      if (user) {
          logoutView.classList.add('hidden');
          loginView.classList.remove('hidden');
          $('#user-name').textContent = user.displayName || 'Utilisateur';
          $('#user-email').textContent = user.email;
          if(user.photoURL) $('#user-avatar').style.backgroundImage = `url(${user.photoURL})`;
          await loadFromCloud();
      } else {
          loginView.classList.add('hidden');
          logoutView.classList.remove('hidden');
          $('#user-id-display').textContent = "Local";
      }
  });

  async function loadFromCloud() {
      if (!currentUser) return;
      $('#last-sync-msg').textContent = "Chargement...";
      
      try {
          const docRef = doc(db, "users", currentUser.uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
              const data = docSnap.data();
              if (data.workEntries) workEntries = JSON.parse(data.workEntries);
              if (data.config) config = { ...config, ...JSON.parse(data.config) };

              localStorage.setItem('worker_entries', JSON.stringify(workEntries));
              localStorage.setItem('worker_config', JSON.stringify(config));

              // UPDATE UI COMPLET
              updateMonthlyView(config.selectedMonthYM);
              updateSettingsUI();
              renderLatestList();
              renderFullHistory(); // Important
              renderDefaultTimesList(); // Important
              if(config.lastSelectedDate) updateEntryUI(config.lastSelectedDate);
              
              $('#last-sync-msg').textContent = "Donn√©es charg√©es ‚úÖ";
          } else {
              await syncData(true);
          }
      } catch (e) {
          console.error("Erreur load:", e);
          $('#last-sync-msg').textContent = "Erreur chargement ‚ùå";
      }
  }

  async function syncData(force = false) {
      if (!currentUser) return;
      $('#last-sync-msg').textContent = "Synchronisation...";
      
      try {
          await setDoc(doc(db, "users", currentUser.uid), {
              workEntries: JSON.stringify(workEntries),
              config: JSON.stringify(config),
              lastUpdated: Timestamp.now()
          }, { merge: true });
          
          const now = new Date();
          const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
          $('#last-sync-msg').textContent = `Sync: ${timeStr} ‚úÖ`;
      } catch (e) {
          console.error("Erreur sync:", e);
          $('#last-sync-msg').textContent = "Erreur synchro ‚ùå";
      }
  }

  // --- STORAGE ---
  function lsLoadEntriesMap() {
    const raw = localStorage.getItem('worker_entries');
    if(!raw) return {};
    const arr = JSON.parse(raw);
    workEntries = Array.isArray(arr) ? arr : [];
    const map = {};
    workEntries.forEach(e => map[e.date] = e);
    return map;
  }
  function lsSaveConfig(cfg) {
    localStorage.setItem('worker_config', JSON.stringify(cfg));
    syncData();
  }
  function saveWorkEntriesLocally() {
    localStorage.setItem('worker_entries', JSON.stringify(workEntries));
    syncData();
    renderFullHistory(); // Mettre √† jour la liste DATA
  }

  function showModal(title, msg) {
    $('#modal-title').textContent = title;
    $('#modal-message').innerHTML = msg;
    $('#custom-modal').style.display = 'flex';
  }

  // --- CORE UI ---
  function getEntry(date) { return workEntries.find(e => e.date === date); }
  
  function updateEntryUI(date) {
    const human = dateToHuman(date);
    $('#entry-date-display').textContent = human;
    $('#entry-date-hidden').value = date;
    
    const entry = getEntry(date);
    if(entry) {
      $('#entry-type-select').value = entry.type;
      $('#start-time').value = entry.start || '';
      $('#end-time').value = entry.end || '';
      $('#lunch-duration-manual').value = entry.lunchDurationMinutes ?? '';
      $('#delete-entry-btn').style.display = 'block';
      $('#save-entry-btn').textContent = 'Modifier';
      $('#save-entry-btn').classList.remove('bg-blue-600');
      $('#save-entry-btn').classList.add('bg-green-600');
    } else {
      $('#entry-type-select').value = 'WORK';
      $('#start-time').value = '';
      $('#end-time').value = '';
      $('#lunch-duration-manual').value = '';
      $('#delete-entry-btn').style.display = 'none';
      $('#save-entry-btn').textContent = 'Enregistrer';
      $('#save-entry-btn').classList.add('bg-blue-600');
      $('#save-entry-btn').classList.remove('bg-green-600');
    }
    
    refreshDayTotal();
    renderLatestList();
  }

  function refreshDayTotal(){
    const type = $('#entry-type-select').value;
    const start = $('#start-time').value;
    const end = $('#end-time').value;
    const lunch = $('#lunch-duration-manual').value ? parseInt($('#lunch-duration-manual').value) : undefined;
    const entry = { type, start, end, lunchDurationMinutes: lunch };
    const workCard = $('#work-card');
    if(type === 'WORK' || type === 'REMOTE') {
       workCard.style.display = 'block';
       setTimeout(()=>workCard.style.opacity = '1', 10);
    } else {
       workCard.style.opacity = '0';
       setTimeout(()=>workCard.style.display = 'none', 300);
    }
    $('#current-day-minutes').textContent = fmtMinutes(calcWorkMinutes(entry));
  }

  function renderLatestList(){
    const container = $('#latest-list');
    const sorted = [...workEntries].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,5);
    container.innerHTML = sorted.map(e => createEntryHTML(e)).join('');
  }

  // --- NOUVELLE FONCTION POUR DATA ---
  function renderFullHistory() {
      const container = $('#data-list-container');
      const sorted = [...workEntries].sort((a,b)=>b.date.localeCompare(a.date));
      if(sorted.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-4">Aucun historique.</div>';
          return;
      }
      container.innerHTML = sorted.map(e => createEntryHTML(e)).join('');
  }

  function createEntryHTML(e) {
       const isWork = (e.type === 'WORK' || e.type === 'REMOTE');
       let rightText = isWork ? fmtMinutes(calcWorkMinutes(e)) : '';
       let colorClass = 'text-blue-400';
       let labelType = e.type;

       if(e.type === 'WORK') { labelType = 'Travail'; colorClass = 'text-green-400'; }
       else if(e.type === 'REMOTE') { labelType = 'T√©l√©travail'; colorClass = 'text-purple-400'; }
       else if(e.type === 'RTT') { labelType = 'RTT'; colorClass = 'text-blue-300'; rightText = '1j'; }
       else if(e.type === 'VACATION') { labelType = 'Cong√©'; colorClass = 'text-pink-400'; rightText = '1j'; }
       else if(e.type === 'HOLIDAY') { labelType = 'F√©ri√©'; colorClass = 'text-yellow-400'; rightText = '1j'; }

       return `
        <div onclick="window.editDate('${e.date}')" class="flex justify-between items-center p-3 bg-[#2C2C2E] rounded-xl active:scale-[0.98] transition-transform">
           <div>
              <div class="text-xs text-gray-400">${formatFrDate(e.date)}</div>
              <div class="font-bold text-sm text-white">${labelType}</div>
           </div>
           <div class="font-bold text-sm ${colorClass}">${rightText}</div>
        </div>
       `;
  }

  function applyAutoFill() {
    const dateStr = $('#entry-date-hidden').value;
    const dayIndex = getDayOfWeekIndex(dateStr);
    const key = DAY_KEYS[dayIndex];
    const def = config.defaultTimes[key];

    if (def && def.start && def.end) {
        $('#start-time').value = def.start;
        $('#end-time').value = def.end;
        showModal('Remplissage Auto', `Horaires appliqu√©s pour ${DAY_NAMES[dayIndex]} : ${def.start} - ${def.end}`);
        refreshDayTotal();
    } else {
        showModal('Information', `Aucun horaire par d√©faut configur√© pour le ${DAY_NAMES[dayIndex]}. Allez dans R√©glages > Pr√©-remplissage.`);
    }
  }

  // --- STATS ---
  function updateMonthlyView(yearMonth) {
    if(!yearMonth) return;
    config.selectedMonthYM = yearMonth;
    lsSaveConfig(config);

    const filtered = workEntries.filter(e => e.date.startsWith(yearMonth));
    let totalMins = 0; let daysWorked = 0; let remoteDays = 0; let officeDays = 0;

    filtered.forEach(e => {
       const m = calcWorkMinutes(e);
       if(e.type === 'WORK' || e.type === 'REMOTE') { totalMins += m; daysWorked++; }
       if(e.type === 'REMOTE') remoteDays++;
       if(e.type === 'WORK') officeDays++;
    });

    const salaryGross = CDI_MONTHLY_HOURS * config.hourlyGrossRate;
    const salaryNet = salaryGross * (1 - BRUT_TO_NET_DEDUCTION);
    const mealAllowance = (officeDays + remoteDays) * config.dailyMealAllowance;
    const kmAllowance = officeDays * config.dailyKmAllowance;
    const grandTotal = salaryNet + mealAllowance + kmAllowance;

    $('#monthly-base-salary-gross').textContent = salaryGross.toFixed(2) + ' ‚Ç¨';
    $('#monthly-base-salary-net').textContent = salaryNet.toFixed(2) + ' ‚Ç¨';
    $('#monthly-meal-allowance').textContent = mealAllowance.toFixed(2) + ' ‚Ç¨';
    $('#monthly-km-allowance').textContent = kmAllowance.toFixed(2) + ' ‚Ç¨';
    $('#monthly-grand-total').textContent = grandTotal.toFixed(2) + ' ‚Ç¨';

    $('#monthly-days-worked').textContent = daysWorked;
    $('#monthly-total-work-hours').textContent = Math.floor(totalMins/60) + 'h';
    $('#monthly-remote-days').textContent = remoteDays;

    recalculateBalances();
    renderMonthlyChart(filtered, yearMonth);
  }

  function renderMonthlyChart(entries, yearMonth) {
     const ctx = document.getElementById('monthly-chart').getContext('2d');
     const [y, m] = yearMonth.split('-').map(Number);
     const daysInMonth = new Date(y, m, 0).getDate();
     const workedEntries = entries.filter(e => e.type === 'WORK' || e.type === 'REMOTE').sort((a,b)=>a.date.localeCompare(b.date));
     const chartLabels = workedEntries.map(e => e.date.substring(8));
     const chartData = workedEntries.map(e => (calcWorkMinutes(e)/60).toFixed(1));
     if (monthlyChartInstance) monthlyChartInstance.destroy();
     monthlyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: chartLabels, datasets: [{ label: 'Heures', data: chartData, backgroundColor: '#0A84FF', borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#333'} }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
     });
  }

  function recalculateBalances() {
      let rttTaken = 0; let vacTaken = 0;
      workEntries.forEach(e => {
          if(e.type === 'RTT') rttTaken++;
          if(e.type === 'VACATION') vacTaken++;
      });
      $('#current-rtt-balance').textContent = (config.initialRttDays - rttTaken);
      $('#current-vacation-balance').textContent = (config.initialVacationDays - vacTaken);
  }

  // --- REGLAGES ---
  function updateSettingsUI() {
    $('#target-hours').value = (config.targetWeeklyHours / 60).toFixed(1);
    $('#lunch-minutes').value = config.lunchDurationMinutes;
    $('#initial-rtt-days').value = config.initialRttDays;
    $('#initial-vacation-days').value = config.initialVacationDays;
    $('#hourly-gross-rate').value = config.hourlyGrossRate.toFixed(2);
    $('#daily-meal-allowance').value = config.dailyMealAllowance.toFixed(2);
    $('#daily-km-allowance').value = config.dailyKmAllowance.toFixed(2);
    
    if(config.userProfilePic) {
        $('#settings-profile-preview').style.backgroundImage = `url(${config.userProfilePic})`;
        $('#settings-profile-preview').textContent = '';
        $('#profile-picture-container').style.backgroundImage = `url(${config.userProfilePic})`;
        $('#profile-initials').textContent = '';
        $('#clear-profile-picture-btn').style.display = 'block';
    }

    const isPrivacy = config.privacyMode;
    $('#toggle-privacy-btn').textContent = isPrivacy ? 'üîí' : 'üîì';
    document.querySelectorAll('.privacy-blur').forEach(el => el.classList.toggle('privacy-visible', !isPrivacy));
  }

  function saveSettings() {
    config.targetWeeklyHours = parseFloat($('#target-hours').value || 0) * 60;
    config.lunchDurationMinutes = parseInt($('#lunch-minutes').value || 0);
    config.initialRttDays = parseInt($('#initial-rtt-days').value || 0);
    config.initialVacationDays = parseInt($('#initial-vacation-days').value || 0);
    config.hourlyGrossRate = parseFloat($('#hourly-gross-rate').value || 0);
    config.dailyMealAllowance = parseFloat($('#daily-meal-allowance').value || 0);
    config.dailyKmAllowance = parseFloat($('#daily-km-allowance').value || 0);
    
    lsSaveConfig(config);
    recalculateBalances();
    updateMonthlyView(config.selectedMonthYM);
    updateSettingsUI();
    showModal('R√©glages Sauvegard√©s', 'Vos pr√©f√©rences ont √©t√© mises √† jour.');
  }

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', () => {
     // Charge Config
     const savedConfig = localStorage.getItem('worker_config');
     if(savedConfig) config = { ...config, ...JSON.parse(savedConfig) };
     
     // Charge Entries
     const map = lsLoadEntriesMap(); 
     
     setupAuthListeners();
     updateSettingsUI();
     updateMonthlyView(config.selectedMonthYM);
     updateEntryUI(config.lastSelectedDate);
     renderFullHistory(); // FIXED
     renderDefaultTimesList(); // FIXED
     
     // Listeners
     $('#entry-type-select').addEventListener('change', refreshDayTotal);
     $('#start-time').addEventListener('change', refreshDayTotal);
     $('#end-time').addEventListener('change', refreshDayTotal);
     $('#lunch-duration-manual').addEventListener('input', refreshDayTotal);
     
     const tabs = ['saisie','hebdo','mensuelle','data','reglages'];
     tabs.forEach(t => {
         $(`#btn-${t}`).onclick = () => {
             document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
             document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('is-active'));
             $(`#tab-${t}`).style.display = 'block';
             $(`#btn-${t}`).classList.add('is-active');
             if(t === 'mensuelle') updateMonthlyView(config.selectedMonthYM);
             if(t === 'reglages') updateSettingsUI();
             if(t === 'data') renderFullHistory(); // Update data tab on click
         }
     });

     $('#save-entry-btn').onclick = () => {
        const date = $('#entry-date-hidden').value;
        const type = $('#entry-type-select').value;
        const start = $('#start-time').value;
        const end = $('#end-time').value;
        const lunch = $('#lunch-duration-manual').value ? parseInt($('#lunch-duration-manual').value) : undefined;
        
        if((type === 'WORK' || type === 'REMOTE') && (!start || !end)) {
            showModal('Erreur', 'Veuillez saisir les horaires.');
            return;
        }
        workEntries = workEntries.filter(e => e.date !== date);
        workEntries.push({ date, type, start, end, lunchDurationMinutes: lunch, timestamp: Date.now() });
        workEntries.sort((a,b) => a.date.localeCompare(b.date));
        
        saveWorkEntriesLocally();
        updateEntryUI(date);
        showModal('Enregistr√©', 'Entr√©e sauvegard√©e avec succ√®s.');
     };

     $('#delete-entry-btn').onclick = () => {
         const date = $('#entry-date-hidden').value;
         if(confirm('Supprimer cette entr√©e ?')) {
             workEntries = workEntries.filter(e => e.date !== date);
             saveWorkEntriesLocally();
             updateEntryUI(date);
         }
     };

     $('#save-settings-btn').onclick = saveSettings;
     $('#toggle-privacy-btn').onclick = () => { config.privacyMode = !config.privacyMode; updateSettingsUI(); lsSaveConfig(config); };
     $('#monthly-privacy-toggle').onclick = () => { config.privacyMode = !config.privacyMode; updateSettingsUI(); lsSaveConfig(config); };

     $('#select-profile-picture-btn').onclick = () => $('#profile-picture-file').click();
     $('#profile-picture-file').onchange = (e) => {
         const file = e.target.files[0];
         if(file) {
             const reader = new FileReader();
             reader.onload = (evt) => { config.userProfilePic = evt.target.result; lsSaveConfig(config); updateSettingsUI(); };
             reader.readAsDataURL(file);
         }
     };

     // CSV EXPORT
     $('#export-data-btn').onclick = () => {
         const header = ["date","type","start","end","lunchDurationMinutes","timestamp"];
         const rows = workEntries.map(e => {
             return [ `"${e.date}"`, `"${e.type}"`, `"${e.start||''}"`, `"${e.end||''}"`, `"${e.lunchDurationMinutes||''}"`, `"${e.timestamp||''}"` ].join(';');
         });
         const csvContent = "data:text/csv;charset=utf-8," + [header.join(';')].concat(rows).join('\n');
         const encodedUri = encodeURI(csvContent);
         const link = document.createElement("a");
         link.setAttribute("href", encodedUri);
         link.setAttribute("download", `worker_data_${new Date().toISOString().slice(0,10)}.csv`);
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
     };

     // CSV IMPORT (FIXED)
     $('#import-data-btn').onclick = () => $('#import-file').click();
     $('#import-file').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const text = evt.target.result;
            const lines = text.split('\n');
            let count = 0;
            for(let i=1; i<lines.length; i++){
                if(!lines[i].trim()) continue;
                const cols = lines[i].split(';').map(c => c.replace(/^"|"$/g, ''));
                if(cols.length >= 2) {
                    const [date, type, start, end, lunch, ts] = cols;
                    workEntries = workEntries.filter(we => we.date !== date);
                    workEntries.push({ date, type, start, end, lunchDurationMinutes: lunch ? parseInt(lunch) : undefined, timestamp: ts ? parseInt(ts) : Date.now() });
                    count++;
                }
            }
            workEntries.sort((a,b) => a.date.localeCompare(b.date));
            saveWorkEntriesLocally(); 
            updateMonthlyView(config.selectedMonthYM);
            renderFullHistory(); // UPDATE DATA TAB
            alert(`${count} entr√©es import√©es avec succ√®s !`);
        };
        reader.readAsText(file);
     };

     $('#entry-date-button').onclick = () => { $('#calendar-modal').style.display = 'flex'; renderCalendar(new Date()); };
     $('#calendar-prev').onclick = () => renderCalendar(addMonthToDate(currentCalDate, -1));
     $('#calendar-next').onclick = () => renderCalendar(addMonthToDate(currentCalDate, 1));
     $('#close-calendar-btn').onclick = () => $('#calendar-modal').style.display = 'none';
     $('#close-modal-btn').onclick = () => $('#custom-modal').style.display = 'none';
     
     $('#auto-fill-btn').onclick = applyAutoFill;

     $('#open-default-times-btn').onclick = () => { renderDefaultTimesList(); $('#default-times-modal').style.display = 'flex'; };
     $('#close-default-times-btn').onclick = () => $('#default-times-modal').style.display = 'none';
     $('#cancel-time-picker-btn').onclick = () => $('#time-picker-modal').style.display = 'none';

     window.editDate = (date) => {
         config.lastSelectedDate = date;
         lsSaveConfig(config);
         updateEntryUI(date);
         $('#calendar-modal').style.display = 'none';
         $('#btn-saisie').click();
     };
     
     setTimeout(() => { $('#splash-screen').style.opacity = '0'; setTimeout(() => $('#splash-screen').style.display = 'none', 400); }, 1000);
     
     populateMonthSelect();
     $('#month-select').onchange = (e) => updateMonthlyView(e.target.value);
     $('#month-prev').onclick = () => { const prev = addMonths(config.selectedMonthYM, -1); $('#month-select').value = prev; updateMonthlyView(prev); };
     $('#month-next').onclick = () => { const next = addMonths(config.selectedMonthYM, 1); $('#month-select').value = next; updateMonthlyView(next); };
  });

  function populateMonthSelect() {
      const sel = $('#month-select');
      sel.innerHTML = '';
      let cur = new Date().toISOString().substring(0,7);
      cur = addMonths(cur, 1); 
      for(let i=0; i<24; i++) { 
          cur = addMonths(cur, -1);
          const opt = document.createElement('option');
          opt.value = cur;
          opt.textContent = monthLabel(cur);
          if(cur === config.selectedMonthYM) opt.selected = true;
          sel.appendChild(opt);
      }
  }

  function renderCalendar(dateObj) {
      currentCalDate = dateObj;
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth();
      $('#calendar-title').textContent = new Intl.DateTimeFormat('fr-FR', {month:'long', year:'numeric'}).format(dateObj);
      const grid = $('#calendar-grid');
      grid.innerHTML = '';
      const firstDay = new Date(year, month, 1).getDay(); 
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const offset = (firstDay + 6) % 7; 
      for(let i=0; i<offset; i++) grid.innerHTML += '<div></div>';
      for(let d=1; d<=daysInMonth; d++) {
          const ymd = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const entry = getEntry(ymd);
          let cls = 'cal-btn hover:bg-gray-700';
          if(ymd === config.lastSelectedDate) cls += ' is-selected';
          if(ymd === dateToYMD(new Date())) cls += ' is-today';
          let icon = '';
          if(entry) {
              if(entry.type === 'WORK') icon = 'üíº'; else if(entry.type === 'REMOTE') icon = 'üè†'; else if(entry.type === 'RTT') icon = 'üèñ'; else if(entry.type === 'VACATION') icon = '‚úàÔ∏è'; else if(entry.type === 'HOLIDAY') icon = 'üéâ';
          }
          grid.innerHTML += `<button class="${cls}" onclick="window.editDate('${ymd}')"><div>${d}</div><div class="text-[10px]">${icon}</div></button>`;
      }
  }
  
  // --- DEFAULT TIMES LOGIC (FIXED) ---
  function renderDefaultTimesList() {
      const container = $('#day-list-container');
      container.innerHTML = '';
      DAY_NAMES.forEach((name, index) => {
          const key = DAY_KEYS[index];
          const def = config.defaultTimes[key];
          const timeStr = (def && def.start) ? `${def.start} - ${def.end}` : 'Non d√©fini';
          const color = (def && def.start) ? 'text-blue-400' : 'text-gray-500';
          
          const div = document.createElement('div');
          div.className = "flex justify-between items-center p-3 bg-[#2C2C2E] rounded-xl active:scale-[0.98] transition-transform";
          div.innerHTML = `<span class="text-white font-medium">${name}</span><span class="text-sm ${color} font-mono">${timeStr}</span>`;
          div.onclick = () => openTimePicker(index);
          container.appendChild(div);
      });
  }

  let currentEditingDayIndex = -1;
  function openTimePicker(dayIndex) {
      currentEditingDayIndex = dayIndex;
      const key = DAY_KEYS[dayIndex];
      const def = config.defaultTimes[key];
      $('#time-picker-title').textContent = DAY_NAMES[dayIndex];
      $('#default-start-time').value = (def && def.start) ? def.start : '09:00';
      $('#default-end-time').value = (def && def.end) ? def.end : '17:30';
      $('#time-picker-modal').style.display = 'flex';
  }

  $('#save-default-times-btn').onclick = () => {
      if(currentEditingDayIndex === -1) return;
      const key = DAY_KEYS[currentEditingDayIndex];
      const start = $('#default-start-time').value;
      const end = $('#default-end-time').value;
      config.defaultTimes[key] = { start, end };
      lsSaveConfig(config);
      renderDefaultTimesList();
      $('#time-picker-modal').style.display = 'none';
  };
  $('#clear-default-times-btn').onclick = () => {
       if(currentEditingDayIndex === -1) return;
       const key = DAY_KEYS[currentEditingDayIndex];
       delete config.defaultTimes[key];
       lsSaveConfig(config);
       renderDefaultTimesList();
       $('#time-picker-modal').style.display = 'none';
  };
</script>
</body>
</html>
